language: go

go: "1.13.x"

addons:
  apt:
    packages:
      - upx

cache:
  directories:
    - $GOPATH/pkg/mod

git:
  depth: 1

env:
  global:
    - LDFLAGS='-s -w'
    - UPX_PARAMS=-7

before_script: cd ./src

script:
  - test -z "$(gofmt -l .)"
  - go test . -v -race -coverprofile=coverage.txt -covermode=atomic
  - go build -ldflags="$LDFLAGS" -o /tmp/tinifier .
  - ls -lh /tmp/tinifier
  - /tmp/tinifier -V
  - /tmp/tinifier -h

after_success:
  - bash <(curl -s https://codecov.io/bash) -f coverage.txt

before_deploy:
  - mkdir /tmp/build
  - GOOS='linux' GOARCH='386' go build -ldflags="$LDFLAGS" -o /tmp/build/tinifier-linux-386 .
  - GOOS='linux' GOARCH='amd64' go build -ldflags="$LDFLAGS" -o /tmp/build/tinifier-linux-amd64 .
  - GOOS='windows' GOARCH='386' go build -ldflags="$LDFLAGS" -o /tmp/build/tinifier-win-386.exe .
  - GOOS='windows' GOARCH='amd64' go build -ldflags="$LDFLAGS" -o /tmp/build/tinifier-win-amd64.exe .
  - upx $UPX_PARAMS /tmp/build/*

deploy:
  - provider: releases
    api_key: "$GITHUB_OAUTH_TOKEN"
    file_glob: true
    file:
      - /tmp/build/*
    skip_cleanup: true
    on:
      tags: true
      branch: master
